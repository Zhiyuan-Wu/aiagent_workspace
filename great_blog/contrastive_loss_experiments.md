# 对比损失实验计划

## 1. 背景与动机

### 1.1 当前损失函数的局限性

**当前实现**（`models.py`）：
- 主要使用二元交叉熵损失（Binary Cross Entropy）
- 简单的辅助损失（回报预测、特征重建）
- 未充分利用成对样本间的对比关系

**主要问题**：
1. **信息利用不足**：只考虑单个股票对的正负样本标签，未考虑与其他股票对的相对关系
2. **表示学习缺失**：未学习股票的鲁棒特征表示
3. **样本利用效率低**：每个样本独立计算损失，未利用全局结构信息
4. **泛化能力弱**：对噪声和异常值敏感，模型泛化能力受限

### 1.2 对比学习优势

**核心思想**：通过对比学习，学习特征表示使得相似样本接近，不相似样本远离

**理论依据**：
- **度量学习**：学习距离空间的度量，使得同类样本距离小
- **表示学习**：学习鲁棒的特征表示，对下游任务有益
- **正则化效果**：对比损失自带正则化效果，提升泛化能力

**预期效果**：
- **准确性提升**：IC提升0.005-0.015
- **稳定性提升**：IC标准差降低10-20%，ICIR提升
- **泛化能力提升**：不同市场环境下表现更稳定

---

## 2. 实验设计原则

### 2.1 固定条件

为避免混淆变量，以下参数在所有实验中保持固定：

- **特征**：使用现有200+因子（不做任何修改）
- **模型架构**：使用MLP基线模型（避免架构干扰）
- **主损失**：保持pairwise排序的BCE损失
- **排序方法**：自适应边界聚焦（使用最优参数）
- **数据范围**：2017-2020年测试集
- **训练数据**：2008-2014年训练集，2015-2016年验证集
- **随机种子**：固定为42（确保可复现性）

### 2.2 评估标准

- **主要指标**：年化收益率（用于选择最优对比损失配置）
- **辅助指标**：IC、Rank IC、夏普比率、最大回撤、ICIR

### 2.3 损失函数设计原则

**总损失组成**：
```
Total Loss = Main Loss + λ × Contrastive Loss
```

其中：
- Main Loss：标准pairwise排序的BCE损失
- λ：对比损失权重（需要调优）
- Contrastive Loss：各种对比损失函数

---

## 3. 实验列表

### 实验 0: Baseline（无对比损失）

**目标**：建立基准性能

**设置描述**：
- 主损失：Binary Cross Entropy
- 对比损失：无（λ=0）
- 辅助损失：无

**预期性能**（基于历史运行）：
- IC: ~0.032-0.040
- 年化收益率: ~9-11%
- 夏普比率: ~0.85-1.05

---

### 实验 1: 对比损失权重扫描

**目标**：确定对比损失的最优权重

**变量**：对比损失权重λ

**详细配置对比**：

**配置1: 极小权重（λ=0.01）**
- 总损失：BCE + 0.01 × Contrastive
- 设计理念：对比损失作为轻微正则化
- 预期效果：
  - IC提升：+0.2-0.5%（略微提升）
  - 年化收益提升：+0.3-0.8%
  - IC标准差降低：3-5%
- 适用场景：关注排序性能，少量正则化
- 优势：不影响主任务学习
- 劣势：正则化效果弱

**配置2: 小权重（λ=0.05）**
- 总损失：BCE + 0.05 × Contrastive
- 设计理念：平衡主任务和正则化
- 预期效果：
  - IC提升：+0.5-1.0%
  - 年化收益提升：+0.8-1.5%
  - IC标准差降低：5-8%
- 适用场景：通用配置
- 优势：平衡效果
- 劣势：无明显

**配置3: 中等权重（λ=0.10）**
- 总损失：BCE + 0.10 × Contrastive
- 设计理念：适度的对比学习
- 预期效果：
  - IC提升：+1.0-1.5%
  - 年化收益提升：+1.5-2.2%
  - IC标准差降低：8-12%
- 适用场景：推荐起点
- 优势：显著提升稳定性
- 劣势：可能略微影响收敛速度

**配置4: 大权重（λ=0.20）**
- 总损失：BCE + 0.20 × Contrastive
- 设计理念：强调表示学习
- 预期效果：
  - IC提升：+1.0-1.8%（可能饱和）
  - 年化收益提升：+1.8-2.5%
  - IC标准差降低：12-15%
- 适用场景：表示学习重要
- 优势：最大化稳定性提升
- 劣势：可能影响主任务性能

**配置5: 极大权重（λ=0.50）**
- 总损失：BCE + 0.50 × Contrastive
- 设计理念：以对比学习为主
- 预期效果：
  - IC提升：+0.5-1.0%（可能下降）
  - 年化收益提升：+1.2-2.0%
  - IC标准差降低：15-18%
- 适用场景：极端情况
- 优势：最强正则化
- 劣势：主任务学习受损

**关键假设**：
- 存在最优权重λ（通常在0.05-0.20之间）
- 权重过小，对比损失效果不明显
- 权重过大，主任务学习受损

**评估方法**：
- 绘制年化收益率 vs λ曲线
- 绘制IC vs λ曲线
- 绘制IC标准差 vs λ曲线
- 寻找最优λ（拐点）

---

### 实验 2: SimCLR风格对比损失

**目标**：评估简单对比学习的有效性

**变量**：温度参数τ

**详细配置对比**：

**配置1: 低温度（τ=0.01）**
- 对比损失：InfoNCE Loss
- 正样本对：同一股票的不同时间（前后1日和2日）
- 负样本对：同一批次内其他股票对
- 公式：exp(sim(z_i, z_j) / τ) / Σ_k exp(sim(z_i, z_k) / τ)
- 设计理念：低温度强调相似度差异
- 预期效果：
  - IC提升：+0.8-1.2%
  - 年化收益提升：+1.5-2.0%
  - 特征表示：更聚集，类内距离小
- 适用场景：数据充足
- 优势：实现简单
- 劣势：对负样本选择敏感

**配置2: 中低温度（τ=0.05）**
- 公式：τ=0.05
- 设计理念：平衡相似度度量和确定性
- 预期效果：
  - IC提升：+1.0-1.5%（最优）
  - 年化收益提升：+2.0-2.5%
  - 特征表示：适度聚集
- 适用场景：推荐配置
- 优势：平衡性能

**配置3: 中等温度（τ=0.10）**
- 公式：τ=0.10
- 设计理念：标准SimCLR温度
- 预期效果：
  - IC提升：+0.8-1.3%
  - 年化收益提升：+1.8-2.3%
  - 特征表示：平衡
- 适用场景：通用配置
- 优势：文献常用值

**配置4: 中高温度（τ=0.20）**
- 公式：τ=0.20
- 设计理念：更高确定性
- 预期效果：
  - IC提升：+0.6-1.0%
  - 年化收益提升：+1.5-2.0%
  - 特征表示：更分散
- 适用场景：数据有限
- 优势：更平滑的梯度

**配置5: 高温度（τ=0.50）**
- 公式：τ=0.50
- 设计理念：强调相似性，降低确定性
- 预期效果：
  - IC提升：+0.4-0.7%
  - 年化收益提升：+1.2-1.6%
  - 特征表示：过于模糊
- 适用场景：探索性
- 优势：梯度更稳定

**关键假设**：
- 温度τ控制"硬度"：低温度→硬相似度，高温度→软相似度
- 最优温度在0.05-0.10之间（A股数据）
- 正负样本定义对性能影响大

**正负样本定义对比**：

**定义A: 时间相邻正样本**
- 正样本：同一股票的t日和t+1日
- 负样本：同一批次其他股票对
- 预期效果：IC +1.0-1.5%
- 优势：自然定义，实现简单
- 劣势：可能引入未来数据泄漏

**定义B: 收益率相近正样本**
- 正样本：收益率差<2%的股票对
- 负样本：收益率差>5%的股票对
- 预期效果：IC +0.8-1.2%
- 优势：明确的相似度标准
- 劣势：需要阈值调优

**定义C: 行业相同正样本**
- 正样本：同行业股票对
- 负样本：不同行业股票对
- 预期效果：IC +0.5-1.0%
- 优势：行业知识
- 劣势：行业分类可能粗糙

**定义D: 排序相近正样本**
- 正样本：排序位次差<10的股票对
- 负样本：排序位次差>50的股票对
- 预期效果：IC +0.7-1.1%
- 优势：考虑排序信息
- 劣势：需要真实排序（可能不可得）

**评估方法**：
- 对比各定义的IC和年化收益
- 分析特征表示聚类质量（Silhouette score）

---

### 实验 3: Triplet Loss对比损失

**目标**：评估三元组损失的效果

**变量**：三元组构建方式

**详细配置对比**：

**配置1: 时间相邻三元组**
- 三元组：(anchor, positive, negative) = (stock_t, stock_t+1, stock_t-2)
- 损失：max(d(a,p) - d(a,n) + margin, 0)
- 距离：欧氏距离或余弦距离
- margin参数：0.2-0.5
- 设计理念：anchor与positive近，与negative远
- 预期效果：
  - IC提升：+1.0-1.8%
  - 年化收益提升：+2.0-3.0%
  - 特征表示：更好的类内紧凑性
- 适用场景：时间序列数据
- 优势：更严格的约束
- 劣势：三元组构建复杂度高

**配置2: 收益率三元组**
- 三元组：anchor=当前股票，positive=高收益股票（>5%），negative=低收益股票（<-5%）
- 损失：max(d(a,p) - d(a,n) + margin, 0)
- margin参数：0.2-0.5
- 设计理念：基于收益选择正负样本
- 预期效果：
  - IC提升：+0.8-1.5%
  - 年化收益提升：+1.8-2.5%
- 适用场景：强调收益区分度
- 优势：明确的语义
- 劣势：依赖阈值

**配置3: 季储三元组**
- 库方法：在训练过程中存储每个anchor的正负样本
- 正样本：该股票历史中表现最好的（前10%）
- 负样本：该股票历史中表现最差的（后10%）
- 预期效果：
  - IC提升：+1.2-2.0%
  - 年化收益提升：+2.2-3.2%
- 适用场景：有历史数据
- 优势：利用历史信息
- 劣势：计算开销

**配置4: 批次困难三元组**
- 困难样本：batch中loss最大的样本
- 三元组：anchor=困难样本，positive=batch内最好，negative=batch内最差
- 设计理念：聚焦困难样本
- 预期效果：
  - IC提升：+1.5-2.2%
  - 年化收益提升：+2.5-3.5%
- 适用场景：数据量大
- 优势：主动学习
- 劣势：实现复杂

**关键假设**：
- Triplet loss比pairwise loss更严格
- margin参数需要调优（通常0.2-0.5）
- 正负样本质量至关重要

**Margin参数扫描**：
- margin ∈ {0.1, 0.2, 0.3, 0.5, 1.0}
- 最优margin通常在0.2-0.3之间

---

### 实验 4: Center Loss对比损失

**目标**：评估基于类中心的对比损失

**变量**：中心计算方式

**详细配置对比**：

**配置1: 全局平均中心**
- 中心计算：所有样本特征的全局平均
- 损失：(distance(x, center) - margin)^2（简化版）
- 预期效果：
  - IC提升：+0.5-1.0%
  - 年化收益提升：+1.0-1.8%
  - 特征表示：全局紧凑
- 适用场景：数据分布均匀
- 优势：计算简单
- 劣势：单个中心可能不足

**配置2: 类别平均中心**
- 中心计算：每个股票类别的平均（如按行业）
- 损失：Σ(distance(x, center_class) - margin)^2
- 预期效果：
  - IC提升：+0.8-1.3%
  - 年化收益提升：+1.5-2.2%
  - 特征表示：类别内紧凑
- 适用场景：有类别信息
- 优势：利用行业知识
- 劣势：需要类别定义

**配置3: 动态更新中心**
- 中心更新：使用动量更新（momentum）
- 更新频率：每batch
- 动量：0.9
- 预期效果：
  - IC提升：+1.0-1.5%
  - 年化收益提升：+1.8-2.5%
  - 特征表示：适应数据分布变化
- 适用场景：非平稳数据
- 优势：自适应
- 劣势：不稳定

**配置4: 硬中心（可学习）**
- 中心：可学习参数（神经网络）
- 损失：包含center正则化项
- 预期效果：
  - IC提升：+1.2-1.8%
  - 年化收益提升：+2.0-2.8%
  - 特征表示：端到端学习
- 适用场景：深度学习
- 优势：灵活性高
- 劣势：增加参数

**关键假设**：
- 中心损失有利于类内紧凑性
- 类别中心优于全局中心
- 动态中心适应非平稳数据

---

### 实验 5: Supervised Contrastive Loss

**目标**：评估有监督对比损失（使用标签信息）

**变量**：监督信息利用方式

**详细配置对比**：

**配置1: 标签加权对比损失**
- 思路：相似度计算时考虑标签相似度
- 权重：w_ij = exp(-|label_i - label_j| / τ)
- 损失：Σ_i w_ij × contrastive_loss(i, j)
- 预期效果：
  - IC提升：+1.2-1.8%
  - 年化收益提升：+2.0-2.8%
- 适用场景：标签信息可靠
- 优势：利用标签相似度
- 劣势：依赖标签质量

**配置2: 困难样本加权对比损失**
- 思路：困难样本（label接近0.5）权重更高
- 权重：w_i = |label_i - 0.5|^β
- β参数：∈{0.5, 1.0, 2.0}
- 预期效果：
  - IC提升：+1.5-2.2%（β=1.0最优）
  - 年化收益提升：+2.2-3.5%
- 适用场景：边界样本重要
- 优势：聚焦关键样本
- 劣势：可能过拟合困难样本

**配置3: 类内对比损失**
- 思路：只在同一类别内计算对比损失
- 类别定义：基于收益率分位数（[0, 0.25, 0.5, 0.75, 1.0）
- 损失：Σ_classes Σ_{i,j∈class} contrastive_loss(i, j)
- 预期效果：
  - IC提升：+1.0-1.5%
  - 年化收益提升：+1.8-2.5%
- 适用场景：有清晰类别划分
- 优势：避免跨类别对比
- 劣势：类别定义可能粗糙

**配置4: 类间对比损失**
- 思路：只在不同类别间计算对比损失
- 类别定义：基于收益率分位数
- 损失：Σ_{classes} Σ_{i∈A,j∈B} contrastive_loss(i, j)
- 预期效果：
  - IC提升：+0.8-1.2%
  - 年化收益提升：+1.5-2.2%
- 适用场景：强调类别区分
- 优势：增强判别能力
- 劣势：损失类别内信息

**关键假设**：
- 有监督对比优于无监督对比
- 标签相似度加权最有效
- 困难样本加权提升边界性能

---

### 实验 6: 双对比损失

**目标**：结合两种互补的对比损失

**变量**：损失组合方式

**详细配置对比**：

**配置1: Instance-level + triplet**
- 损失1：SimCLR（正负样本对）
- 损失2：Triplet（三元组）
- 权重：λ1=0.7, λ2=0.3
- 总损失：BCE + 0.7×L1 + 0.3×L2
- 预期效果：
  - IC提升：+1.5-2.2%
  - 年化收益提升：+2.5-3.8%
- 适用场景：一般情况
- 优势：互补学习
- 劣势：调参复杂

**配置2: Instance-level + center**
- 损失1：SimCLR（正负样本对）
- 损失2：Center loss（类中心）
- 权重：λ1=0.6, λ2=0.4
- 总损失：BCE + 0.6×L1 + 0.4×L2
- 预期效果：
  - IC提升：+1.3-1.9%
  - 年化收益提升：+2.2-3.2%
- 适用场景：需要紧凑表示
- 优势：同时学习判别和紧凑性
- 劣势：损失间可能冲突

**配置3: Supervised + triplet**
- 损失1：标签加权对比
- 损失2：Triplet
- 权重：λ1=0.5, λ2=0.5
- 总损失：BCE + 0.5×L1 + 0.5×L2
- 预期效果：
  - IC提升：+1.8-2.5%
  - 年化收益提升：+2.8-4.0%
- 适用场景：标签可靠
- 优势：充分利用标签
- 劣势：依赖标签质量

**配置4: Supervised + center**
- 损失1：标签加权对比
- 损失2：Center loss
- 权重：λ1=0.6, λ2=0.4
- 总损失：BCE + 0.6×L1 + 0.4×L2
- 预期效果：
  - IC提升：+1.5-2.2%
  - 年化收益提升：+2.5-3.5%
- 适用场景：推荐配置
- 优势：标签+紧凑性
- 劣势：损失间可能冲突

**配置5: 三对比损失**
- 损失1：SimCLR
- 损失2：Triplet
- 损失3：Center
- 权重：λ1=0.4, λ2=0.3, λ3=0.3
- 总损失：BCE + 0.4×L1 + 0.3×L2 + 0.3×L3
- 预期效果：
  - IC提升：+1.6-2.3%（可能过拟合）
  - 年化收益提升：+2.5-3.8%
- 适用场景：数据充足
- 优势：多维度学习
- 劣势：复杂度高，过拟合风险

**关键假设**：
- 多损失提供互补信号
- 权重分配需要仔细调优
- 过多损失可能导致过拟合

---

## 4. 实验执行与评估流程

### 4.1 执行顺序

```
实验0（Baseline无对比损失）
    ↓
实验1（对比损失权重扫描）→ 确定最优λ
    ↓
实验2（SimCLR风格）→ 确定最优温度τ和正负样本定义
    ↓
实验3（Triplet Loss）→ 确定最优margin
    ↓
实验4（Center Loss）→ 确定最优中心方式
    ↓
实验5（Supervised Contrastive）→ 确定最优监督方式
    ↓
实验6（双对比损失）→ 确定最优组合
    ↓
综合分析与最优配置推荐
```

### 4.2 结果记录

**每个实验记录**：
- 参数配置
- IC, Rank IC, ICIR
- 年化收益率、夏普比率、最大回撤、Calmar比率
- 特征表示质量指标（Silhouette score, Davies-Bouldin index）
- 训练时间

**结果存储路径**：
```
data/experiments/contrastive_loss/
├── exp00_baseline/
│   ├── config.json
│   ├── results.csv
│   └── plots/
├── exp01_weight_scan/
├── exp02_simclr/
├── ...
└── exp06_dual_loss/
```

### 4.3 可视化分析

**关键可视化**：
1. **权重扫描曲线**：年化收益率 vs λ
2. **温度扫描曲线**：年化收益率 vs τ
3. **特征表示可视化**：t-SNE 2D投影对比（有/无对比损失）
4. **损失对比柱状图**：各配置的IC和年化收益
5. **训练曲线**：主损失 vs 对比损失 vs 总损失

---

## 5. 预期贡献

### 5.1 性能提升预期

基于对比学习理论，预期达到以下效果：

| 改进方向 | IC提升 | 年化收益提升 | 夏普比率提升 | 最大回撤降低 |
|---------|---------|--------------|-----------|-----------|
| 对比损失权重优化 | +0.005-0.010 | +1.5-2.5% | +0.05-0.15 | -3-8% |
| SimCLR风格 | +0.008-0.015 | +2.0-3.5% | +0.10-0.20 | -5-10% |
| Triplet Loss | +0.010-0.020 | +2.5-4.0% | +0.12-0.25 | -5-12% |
| 双对比损失 | +0.015-0.025 | +3.0-5.0% | +0.18-0.35 | -8-15% |

**综合最优配置预期**（组合多个改进）：
- IC提升：从~0.035 → ~0.045-0.055
- 年化收益提升：从~9-11% → ~13-17%
- 夏普比率提升：从~0.9-1.1 → ~1.15-1.40
- 最大回撤降低：从~32-38% → ~22-28%
- ICIR提升：15-30%

### 5.2 学术贡献

- **系统性研究**：对比学习在pairwise排序量化投资中的应用
- **方法对比**：多种对比损失的系统性比较分析
- **实证分析**：基于A股数据的对比损失效果量化分析

### 5.3 实践贡献

- **最优配置推荐**：基于实证数据的最优对比损失配置
- **性能提升**：可操作的3-5%年化收益提升
- **稳定性提升**：ICIR提升15-30%，增强策略可靠性

---

## 6. 时间估算

| 实验编号 | 实验名称 | 配置数量 | 预计耗时（小时） |
|---------|---------|---------|----------------|
| 0 | Baseline | 1 | 2-3 |
| 1 | 权重扫描 | 5 | 6-10 |
| 2 | SimCLR风格 | 5×4 | 10-16 |
| 3 | Triplet Loss | 4 | 8-12 |
| 4 | Center Loss | 4 | 6-10 |
| 5 | Supervised Contrastive | 4 | 8-12 |
| 6 | 双对比损失 | 5 | 10-16 |
| **总计** | | | **50-79 小时** |

**建议执行周期**：1.5-2周（每周25-35小时计算时间）

---

## 7. 风险与缓解

### 7.1 技术风险

| 风险 | 影响 | 缓解措施 |
|-----|------|---------|
| 对比损失实现复杂 | Bug风险 | 单元测试，对比标准实现 |
| 过拟合训练集 | 测试集性能差 | 时间序列交叉验证，正则化 |
| 训算资源需求大 | 训练时间长 | 批处理，GPU加速 |

### 7.2 业务风险

| 风险 | 影响 | 缓解措施 |
|-----|------|---------|
| 对比损失不稳定 | 回测表现波动 | 集成学习，权重衰减 |
| 特征表示过度紧凑 | 丢失判别能力 | 正则化强度调优 |

---

## 8. 成功标准

**实验计划成功的标志**：
1. ✓ 找到相对于Baseline有显著提升（年化收益>2%）的最优对比损失配置
2. ✓ 理解不同对比损失特性对性能的影响规律
3. ✓ 形成可复现的对比损失集成框架
4. ✓ 完成实验报告与可视化分析
5. ✓ 提供明确的对比损失配置推荐
