### 深度学习因子模型优化实验方案

#### 1. 背景  
当前 `myportfolio.py` 实现了一个基础的多层感知机（MLP）模型，用于根据输入特征（alpha因子）预测股票收益排序并构建投资组合。该实现较为简单，缺乏现代深度学习中提升性能与稳定性的关键技术。为系统性地探索在A股市场（特别是中证500成分股池）上表现更优的深度学习架构，制定本实验计划。采用**贪心搜索策略**：每个新实验均基于迄今为止回测年化收益率最高的配置，并仅改变一个维度的设置，以清晰评估该修改对投资绩效的影响。

#### 2. 基线模型 (Baseline)  
- **网络结构**: 2个隐藏层，每层64个神经元  
- **激活函数**: ReLU  
- **归一化**: 无  
- **正则化**: 无显式正则化（L2权重衰减设为0）  
- **损失函数**: **Pairwise Ranking Loss**。模型接收一对股票的特征向量，输出各自得分，通过二元交叉熵或类似分类损失鼓励高收益股票得分更高  
- **优化器**: Adam，初始学习率 1e-3  
- **训练设置**: Batch size = 4096，训练轮次 = 50  
- **其他**: 无残差连接、无辅助损失、无特征预处理  

---

#### 3. 实验列表  

**实验 1: 输入特征归一化**  
- **目标**: 评估全局特征标准化对训练稳定性与泛化能力的影响  
- **变量**: 是否对输入特征进行Z-Score标准化  
- **设置**:  
  - **对照组**: Baseline（原始特征）  
  - **实验组**: 在整个训练集上计算各因子的均值与标准差，对所有数据（训练/验证/测试）进行统一标准化  
- **预期**: 消除量纲差异，加速收敛，提升模型鲁棒性  

**实验 2: 残差连接 (Residual Connections)**  
- **目标**: 缓解深度网络中的梯度退化问题，支持更深架构  
- **变量**: 是否引入跳跃连接  
- **设置**（基于实验2中表现最好的深度模型，如6层×64）:  
  - **对照组**: 标准6层全连接网络  
  - **实验组**: 重构为3个残差块（每块含2个线性层），维度不匹配时使用线性投影层对齐  
- **预期**: 提升深度模型的可训练性与性能  

**实验 3: 网络深度与宽度探索**  
- **目标**: 探索模型容量对性能的影响，确定合适的规模  
- **变量**: 隐藏层数量与每层神经元数  
- **设置**（基于实验1的最佳结果）:  
  - **对照组**: 当前最佳配置（如2层×64）  
  - **实验组 A（深度）**: [4, 6, 8] 层 × 64 单元  
  - **实验组 B（宽度）**: 2 层 × [128, 256, 512] 单元  
  - **实验组 C（深度+宽度）**: [4, 6] 层 × [128, 256] 单元  

**实验 4: 归一化策略 (BatchNorm vs. LayerNorm)**  
- **目标**: 评估不同归一化方法对训练动态和泛化的影响  
- **变量**: 隐藏层后的归一化类型  
- **设置**（基于实验3的最佳结果）:  
  - **对照组**: 无归一化  
  - **实验组 A**: 每个线性层后、激活前添加 `BatchNorm1d`  
  - **实验组 B**: 每个线性层后、激活前添加 `LayerNorm`  
- **预期**: `LayerNorm` 更适应金融时间序列的小批量与非平稳特性  

**实验 5: 辅助损失函数**  
- **目标**: 通过多任务学习引入归纳偏置，提升表征质量  
- **变量**: 辅助任务类型  
- **设置**（基于实验4的最佳结果）:  
  - **对照组**: 仅主任务（Pairwise Ranking Loss）  
  - **实验组 A（收益预测）**: 总损失 = 主损失 + λ₁ × MSE(预测收益, 真实收益)  
  - **实验组 B（特征重建）**: 总损失 = 主损失 + λ₂ × MSE(重建特征, 原始特征)，通过掩码自编码结构实现  
  - **超参**: λ₁, λ₂ ∈ {0.1, 0.5, 1.0}  
- **预期**: 辅助任务作为正则化手段，抑制过拟合，增强经济意义  

**实验 6: 优化与正则化**  
- **目标**: 综合提升收敛质量与样本外泛化能力  
- **变量**: 优化器策略与显式正则化  
- **设置**（基于实验5的最佳结果）:  
  - **对照组**: Adam (lr=1e-3)，固定学习率，无Dropout，固定50轮  
  - **实验组 A（学习率调度）**: Adam + CosineAnnealingLR (T_max=50)  
  - **实验组 B（优化器）**: RAdam 或 AdamW (weight_decay=1e-4)  
  - **实验组 C（正则化）**: 在隐藏层后添加 Dropout (p ∈ {0.2, 0.3, 0.5})，并结合 Early Stopping（耐心值=10，监控验证集主损失）  
- **预期**: 改善优化轨迹，有效控制过拟合  

---

#### 4. 实验执行与评估流程  
1. **顺序依赖**: 每个实验严格基于前序实验中年化收益率最高的配置进行。  
2. **可复现性**: 所有实验使用相同随机种子，确保结果一致。  
3. **回测一致性**: 所有模型在完全相同的回测框架下评估，包括数据范围、交易成本、行业中性化逻辑及组合构建规则。  
4. **多维评估**: 以**年化收益率**为主要选择标准，同时记录夏普比率、最大回撤、Calmar比率等指标，用于综合判断，避免单一指标过拟合。  
5. **失败回退**: 若某实验所有变体均劣于其对照组，则保留原配置，继续后续实验。  
6. **稳健性验证**: 完成全部实验后，对最终选定的最佳模型进行滚动窗口（Walk-Forward）分析，检验其在不同市场周期下的稳定性。
